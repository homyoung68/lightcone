<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>연구실 홈페이지</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#111827; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb; --brand:#2563eb; --ring:#93c5fd;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1020; --fg:#e5e7eb; --muted:#9aa0a6; --card:#0f162e; --border:#1f2937; --brand:#60a5fa; --ring:#2563eb;
      }
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--fg) }
    a{ color:inherit; text-decoration:none }
    header{ position:sticky; top:0; background:rgba(255,255,255,.9); backdrop-filter:blur(8px); border-bottom:1px solid var(--border) }
    @media (prefers-color-scheme: dark){ header{ background:rgba(15,22,46,.85) } }
    .nav{ max-width:960px; margin:0 auto; display:flex; gap:12px; align-items:center; justify-content:space-between; padding:10px 16px }
    .title{ display:flex; gap:10px; align-items:center; font-weight:800; letter-spacing:-.2px }
    .logo{ width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg, var(--brand), #7c3aed) }
    .links{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn{ border:1px solid var(--border); background:var(--card); color:var(--fg); border-radius:10px; padding:8px 10px; cursor:pointer }
    main{ max-width:960px; margin:0 auto; padding:24px 16px }
    section{ scroll-margin-top:72px; margin-top:24px }
    h2{ margin:0 0 10px; font-size:22px }
    .sub{ color:var(--muted); margin:4px 0 16px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px }
    .grid{ display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)) }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .pill{ display:inline-block; padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted) }
    .editable{ outline:none; border-radius:8px }
    .editable:focus{ box-shadow:0 0 0 3px var(--ring) }
    .avatar{ width:140px; height:140px; border-radius:12px; border:1px solid var(--border); object-fit:cover; background:#ddd }
    .muted{ color:var(--muted) }
    .a-btn{ display:inline-block; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:var(--card) }
    footer{ border-top:1px solid var(--border); margin-top:24px; color:var(--muted) }
    .foot{ max-width:960px; margin:0 auto; padding:16px }
    .badge{ position:fixed; right:12px; bottom:12px; background:#10b981; color:#fff; padding:6px 10px; border-radius:8px; font-size:12px; z-index:9999 }
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="title">
        <div class="logo" aria-hidden="true"></div>
        <a id="labName" class="editable" contenteditable="true">□□□ 연구실</a>
      </div>
      <div class="links">
        <a href="#people">교수 소개</a>
        <a href="#publications">연구</a>
        <a href="#teaching">수업자료</a>
        <button id="toggleTheme" class="btn">🌗 테마</button>
        <button id="resetAll" class="btn">♻️ 초기화</button>
      </div>
    </nav>
  </header>

  <main>
    <section id="home">
      <h1 id="heroTitle" class="editable" contenteditable="true">□□□ 연구실 (Lab for □□□)</h1>
      <p id="heroDesc" class="sub editable" contenteditable="true">데스크탑에서 바로 편집 가능하도록 설정된 버전입니다.</p>
    </section>

    <section id="people">
      <h2>교수 소개</h2>
      <div class="card" style="display:grid; grid-template-columns:140px 1fr; gap:16px">
        <div style="display:grid; gap:10px; justify-items:center">
          <img id="profPhoto" class="avatar" alt="교수 사진" src="">
          <input id="photoFile" type="file" accept="image/*" hidden>
          <button id="changePhoto" class="btn">사진 변경</button>
          <button id="removePhoto" class="btn">사진 제거</button>
          <div class="muted" style="font-size:12px">권장: 정사각형 JPG/PNG</div>
        </div>
        <div>
          <div class="row">
            <strong id="profName" class="editable" contenteditable="true">홍길동</strong>
            <span class="pill">교수</span>
          </div>
          <div id="profAffil" class="editable muted" contenteditable="true" style="margin-top:4px;">□□대학교 물리학과</div>
          <div style="margin-top:10px; display:grid; gap:6px; font-size:14px">
            <div><strong>B.S.</strong> · <span id="degB" class="editable" contenteditable="true">○○대학교</span></div>
            <div><strong>M.S.</strong> · <span id="degM" class="editable" contenteditable="true">○○대학교</span></div>
            <div><strong>Ph.D.</strong> · <span id="degP" class="editable" contenteditable="true">○○대학교</span></div>
            <div><strong>Postdoc</strong> · <span id="degPostdoc" class="editable" contenteditable="true">○○ 연구소/대학교</span></div>
          </div>
          <div style="margin-top:10px; font-size:14px">
            <span class="muted">이메일</span> · <span id="profEmail" class="editable" contenteditable="true">email@example.edu</span>
          </div>
        </div>
      </div>
    </section>

    <section id="publications">
      <h2>📄 연구</h2>
      <p class="sub">
        <a href="https://inspirehep.net/authors/1013647?ui-citation-summary=true" target="_blank" rel="noopener">
          INSPIRE HEP(링크는 여기에)
        </a>
      </p>
    </section>

    <section id="teaching">
      <h2>수업자료</h2>
      <p class="sub">모든 과목의 자료 버튼은 동일한 폴더로 이동합니다(보기 전용 권장).</p>
      <div id="courseGrid" class="grid"></div>
    </section>
  </main>

  <footer>
    <div class="foot">© <span id="year"></span> <span id="footerLab">□□□ 연구실</span></div>
  </footer>

<script>
  // ----- Safe storage wrapper -----
  const storage = (()=>{ try{ const t='__t'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; }catch(e){ return {getItem:()=>null,setItem:()=>{},removeItem:()=>{}} } })();

  // ----- Storage schema: bump to reset old edits -----
  (function schemaReset(){
    const SCHEMA='lab.schema.v5'; // 새 배포 시 숫자 올리면 옛 저장값 자동 초기화
    const KEY='lab.__schema_version';
    try{
      const cur=storage.getItem(KEY);
      if(cur!==SCHEMA){
        Object.keys(localStorage||{}).filter(k=>k.startsWith('lab.')).forEach(k=>storage.removeItem(k));
        storage.setItem(KEY,SCHEMA);
        console.log('[lab] storage reset ->',SCHEMA);
      }
    }catch(e){}
  })();

  // ----- Theme toggle -----
  const rootEl=document.documentElement;
  const savedTheme=storage.getItem('lab.theme');
  if(savedTheme==='dark') rootEl.classList.add('dark');
  document.getElementById('toggleTheme').addEventListener('click',()=>{
    rootEl.classList.toggle('dark');
    storage.setItem('lab.theme', rootEl.classList.contains('dark')?'dark':'light');
  });

  // ----- Auto persist editable text -----
  function autoPersist(el,key){
    const v=storage.getItem(key); if(v!==null) el.textContent=v;
    let t; const save=()=>storage.setItem(key, el.textContent.trim());
    el.addEventListener('blur',save);
    el.addEventListener('input',()=>{ clearTimeout(t); t=setTimeout(save,250); });
  }
  [['lab.name','labName'],['lab.hero.title','heroTitle'],['lab.hero.desc','heroDesc'],
   ['lab.prof.name','profName'],['lab.prof.affil','profAffil'],['lab.prof.email','profEmail'],
   ['lab.prof.degB','degB'],['lab.prof.degM','degM'],['lab.prof.degP','degP'],['lab.prof.postdoc','degPostdoc']]
   .forEach(([k,id])=>{const el=document.getElementById(id); if(el) autoPersist(el,k);});

  // footer lab name sync
  function syncFooter(){ const name=(storage.getItem('lab.name')||'□□□ 연구실').replace(/<[^>]*>/g,''); document.getElementById('footerLab').textContent=name; }
  window.addEventListener('storage',syncFooter); syncFooter();

  // ----- Photo (dataURL) -----
  const profPhoto=document.getElementById('profPhoto'); const photoKey='lab.prof.photo';
  const savedPhoto=storage.getItem(photoKey); if(savedPhoto) profPhoto.src=savedPhoto;
  document.getElementById('changePhoto').addEventListener('click',()=>document.getElementById('photoFile').click());
  document.getElementById('photoFile').addEventListener('change',(e)=>{
    const f=e.target.files&&e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{ storage.setItem(photoKey,r.result); profPhoto.src=r.result; }; r.readAsDataURL(f);
  });
  document.getElementById('removePhoto').addEventListener('click',()=>{ storage.removeItem(photoKey); profPhoto.src=''; });

  // ----- Fixed Drive folder -----
  const DRIVE_FOLDER_URL = "https://drive.google.com/drive/folders/18Y-_ALYRli2JYrDk8Q3bt3M4UiuGaB46";

  // ----- Courses (3) with editable titles/years, fixed link -----
  const defaultCourses = [
    { id:'Mech', title:'역학',   year:'2025-1' },
    { id:'EM',   title:'전자기', year:'2025-1' },
    { id:'QM',   title:'양자',   year:'2025-1' },
  ];
  let courses = JSON.parse(storage.getItem('lab.courses')||'null') || defaultCourses;
  const courseGrid=document.getElementById('courseGrid');
  function saveCourses(){ storage.setItem('lab.courses', JSON.stringify(courses)); }
  function renderCourses(){
    courseGrid.innerHTML='';
    courses.forEach((c,ci)=>{
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`
        <h3 class="editable editable-title" contenteditable="true" data-ci="${ci}">
          ${c.title} <span class="muted" style="font-weight:400; font-size:14px">(${c.year})</span>
        </h3>
        <a class="a-btn" href="${DRIVE_FOLDER_URL}" target="_blank" rel="noopener">📁 자료 폴더 열기</a>
      `;
      courseGrid.appendChild(card);
    });
    document.querySelectorAll('.editable-title').forEach(h=>{
      h.addEventListener('blur', ()=>{
        const idx=+h.dataset.ci; const text=h.textContent.trim();
        const m=text.match(/^(.*?)(\(([^)]*)\))?$/); // "제목 (연도)" 형태
        courses[idx].title = (m && m[1].trim()) || text;
        if(m && m[3]) courses[idx].year = m[3].trim();
        saveCourses();
      });
    });
  }
  renderCourses();

  // ----- Reset button -----
  document.getElementById('resetAll').addEventListener('click',()=>{
    if(!confirm('저장된 편집 내용을 모두 초기화할까요?')) return;
    Object.keys(localStorage||{}).filter(k=>k.startsWith('lab.')).forEach(k=>storage.removeItem(k));
    location.reload();
  });

  // year
  document.getElementById('year').textContent=new Date().getFullYear();

  // ----- Edit mode: allow on file://, localhost, or ?edit=1 -----
  (function enableEditWhereAppropriate(){
    const isLocalHost = /^(localhost|127\.0\.0\.1)$/i.test(location.hostname);
    const isFile = location.protocol === 'file:';
    const url = new URL(location.href);
    const hasEditFlag = url.searchParams.has('edit') || location.hash.includes('edit');
    const canEdit = isLocalHost || isFile || hasEditFlag;

    if (canEdit) {
      const b=document.createElement('div'); b.className='badge'; b.textContent='✎ EDIT MODE (텍스트 편집 가능)'; document.body.appendChild(b);
      return; // 편집 허용: contenteditable 유지
    }
    // 보기 전용(공개 배포 시)
    document.querySelectorAll('.editable,[contenteditable="true"]').forEach(el=>{ el.removeAttribute('contenteditable'); el.classList.remove('editable'); });
  })();
</script>
</body>
</html>
